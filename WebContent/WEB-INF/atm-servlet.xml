<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
	   xmlns:security="http://www.springframework.org/schema/security"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       http://www.springframework.org/schema/security 
       http://www.springframework.org/schema/security/spring-security-2.0.4.xsd">

  <!-- the application context definition for the springapp DispatcherServlet -->

    <bean id="messageSource" class="org.springframework.context.support.ResourceBundleMessageSource">
        <property name="basename" value="messages"/>
    </bean>


  <!--  Controlers -->
  
  

    <bean name="/login.htm"  class="atm.controler.ConnectionFormControler">
    </bean>
      
    <bean name="/transactions_panel.htm" class="atm.controler.TransactionsPanelControler">
    </bean>      

    <bean name="/transactions_history.htm" class="atm.controler.TransactionsHistoryControler">  
    	<property name="transactions" ref="transactions"/>
    </bean> 
    
    
    <bean name="/balance.htm" class="atm.controler.BalanceControler">  
    	   <property name="accountDAO" ref="accountDAO"/>
    </bean> 


    <bean name="/deposit.htm"  class="atm.controler.DepositControler">
        <property name="sessionForm" value="false"/>
        <property  name="commandName" value="depositForm"/>
        <property name="commandClass" value="atm.service.DepositManager"/>
        <property name="validator" ref="depositValidator"/>
        <property name="formView" value="deposit"/>
        <property name="successView" value="transactions_panel.htm"/>
   		<property name="accountDAO" ref="accountDAO"/>	
   		<property name="transactionDAO" ref="transactionDAO"/>	        
   </bean>
	<bean  id="depositValidator" class="atm.validator.DepositValidator">
	 		<property name="accountDAO" ref="accountDAO"/>	
			<property name="transactionDAO" ref="transactionDAO"/>		 
	</bean>  
 
    <bean name="/withdrawal.htm"  class="atm.controler.WithdrawalControler">
        <property name="sessionForm" value="false"/>
        <property  name="commandName" value="withdrawalForm"/>
        <property name="commandClass" value="atm.service.WithdrawalManager"/>
        <property name="validator"  ref="withdrawalValidator"/>
        <property name="formView" value="withdrawal"/>
        <property name="successView" value="transactions_panel.htm"/>
   		<property name="accountDAO" ref="accountDAO"/>	
   		<property name="transactionDAO" ref="transactionDAO"/>	        
    </bean> 
     <bean  id="withdrawalValidator" class="atm.validator.WithdrawalValidator">
    		<property name="accountDAO" ref="accountDAO"/>	
    		<property name="transactionDAO" ref="transactionDAO"/>	 
    </bean>     
    
    
    <bean name="/disconnection.htm" class="atm.controler.DisconnectionControler">
    </bean>         
    
 
	<!-- Stratégie de Sécurité : ressources et Remember me -->
	<security:http auto-config="true">
	 	<security:intercept-url pattern="/login.jsp*" filters="none"/>
	 	<security:intercept-url pattern="/WEB-INF/jsp/login.jsp*" filters="none"/>
		<security:intercept-url pattern="/logo*" filters="none"/>  
		<security:intercept-url pattern="/**/messages*" filters="none"/> 
		<security:intercept-url pattern="/style.css" filters="none"/>  
		<security:intercept-url pattern="/**" access="ROLE_USER,ROLE_MAINTENANCE"/>
  		<security:form-login login-page="/login.jsp"/>
	</security:http>

	<!-- Authentification via Database personalisée : Exemple avec tables 'employes' et 'roles' 
	Attention à la colonne 'enabled' à ajouter
	-->
	      
	<security:authentication-provider user-service-ref='myUserDetailsService' >
		<security:password-encoder hash="md5"/>
	</security:authentication-provider>
		
	<bean id="myUserDetailsService" class="org.springframework.security.userdetails.jdbc.JdbcDaoImpl">
	  <property name="dataSource" ref="dataSource"/>
	  <property name="usersByUsernameQuery" value="SELECT cardNumber as username, nip as password,'true' as enabled FROM CustomerCard WHERE cardNumber = ?"/>
	  <property name="authoritiesByUsernameQuery" value="SELECT cardNumber as username, role FROM CustomerCard INNER JOIN role on CustomerCard.accountNumber = role.accountNumber WHERE cardNumber = ? "/>
	</bean> 
	      
	 
    <!--  ViewResolver -->  
    <bean id="viewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver">
        <property name="viewClass" value="org.springframework.web.servlet.view.JstlView"></property>
        <property name="prefix" value="/WEB-INF/jsp/"></property>
        <property name="suffix" value=".jsp"></property>        
    </bean>  
  
</beans>